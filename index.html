<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Google Drive Explorer</title>

<!-- Google Identity Services -->
<script src="https://accounts.google.com/gsi/client"></script>

<!-- Google API (IMPORTANT: onload) -->
<script src="https://apis.google.com/js/api.js" async defer onload="gapiLoaded()"></script>

<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background:#f4f4f9;
    margin:0;
    padding:0;
}
header {
    background:#1a73e8;
    color:white;
    padding:15px;
    text-align:center;
    font-size:24px;
    font-weight:bold;
}
.container {
    max-width:900px;
    margin:20px auto;
    padding:10px;
}
.buttons {
    margin-bottom:20px;
}
button {
    background:#1a73e8;
    color:white;
    border:none;
    padding:10px 18px;
    border-radius:5px;
    margin-right:10px;
    cursor:pointer;
    font-size:16px;
}
button:hover {
    background:#155bb5;
}
.file-grid {
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
    gap:15px;
}
.card {
    background:white;
    padding:12px;
    border-radius:8px;
    box-shadow:0px 2px 5px rgba(0,0,0,0.1);
    text-align:center;
    cursor:pointer;
    transition:transform 0.2s, box-shadow 0.2s;
    position:relative;
}
.card:hover {
    transform:translateY(-5px);
    box-shadow:0px 6px 15px rgba(0,0,0,0.2);
}
.folder-icon {
    font-size:40px;
    color:#fbbc04;
}
.file-icon {
    font-size:40px;
    color:#34a853;
}
.excel-icon {
    font-size:40px;
    color:#0f9d58;
}
.filename {
    margin-top:10px;
    font-weight:500;
    word-break:break-word;
}
.excel-btn {
    background:#0f9d58;
    margin-top:5px;
    padding:5px 10px;
    font-size:12px;
}
.excel-btn:hover {
    background:#0b8043;
}

/* Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
.table-container {
    margin-top:30px;
    background:white;
    border-radius:8px;
    box-shadow:0px 2px 10px rgba(0,0,0,0.1);
    padding:20px;
    overflow-x:auto;
}
table {
    width:100%;
    border-collapse:collapse;
}
th, td {
    padding:12px;
    text-align:left;
    border-bottom:1px solid #ddd;
}
th {
    background:#f1f1f1;
    font-weight:600;
}
tr:hover {
    background:#f9f9f9;
}
.loading {
    text-align:center;
    padding:20px;
    color:#666;
}
</style>
</head>

<body>

<header>ğŸ“ Google Drive Explorer</header>

<div class="container">
    <div class="buttons">
        <button id="loginBtn">Sign In</button>
        <button id="logoutBtn" style="display:none;">Sign Out</button>
        <button onclick="goBack()">ğŸ”™ Go Back</button>
        <button onclick="closeTable()" id="closeTableBtn" style="display:none; background:#d93025;">Close Table</button>
    </div>

    <div id="files" class="file-grid"></div>
    
    <div id="tableContainer" class="table-container" style="display:none;"></div>
</div>

<script>
const CLIENT_ID = "418351745250-48015ia9v4rimop44nm3dshqmjr19c1o.apps.googleusercontent.com";
const DRIVE_SCOPE = "https://www.googleapis.com/auth/drive.readonly";
const SHEETS_SCOPE = "https://www.googleapis.com/auth/spreadsheets.readonly";
const SCOPES = `${DRIVE_SCOPE} ${SHEETS_SCOPE}`;

let folderStack = ["root"];
let tokenClient;
let currentSpreadsheetId = null;

// Called AFTER gapi.js loads
function gapiLoaded() {
    gapi.load("client", async () => {
        await gapi.client.init({
            apiKey: '',
            discoveryDocs: [
                "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
                "https://sheets.googleapis.com/$discovery/rest?version=v4"
            ]
        });

        const savedToken = localStorage.getItem("gdrive_token");
        if (savedToken) {
            gapi.client.setToken({ access_token: savedToken });
            afterLogin();
        }
    });
}

// Login
document.getElementById("loginBtn").onclick = () => {
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: (resp) => {
            if (resp.access_token) {
                localStorage.setItem("gdrive_token", resp.access_token);
                gapi.client.setToken(resp);
                afterLogin();
            }
        }
    });
    tokenClient.requestAccessToken();
};

// After successful login
function afterLogin() {
    document.getElementById("loginBtn").style.display = "none";
    document.getElementById("logoutBtn").style.display = "inline-block";
    folderStack = ["root"];
    loadFolder("root");
}

// Logout
document.getElementById("logoutBtn").onclick = () => {
    const token = gapi.client.getToken();
    if (token) {
        google.accounts.oauth2.revoke(token.access_token);
        gapi.client.setToken("");
    }
    localStorage.removeItem("gdrive_token");
    location.reload();
};

// Load folder content
async function loadFolder(folderId) {
    try {
        const res = await gapi.client.drive.files.list({
            q: `'${folderId}' in parents and trashed = false`,
            fields: "files(id, name, mimeType, iconLink)"
        });

        const container = document.getElementById("files");
        container.innerHTML = "";

        if (res.result.files.length === 0) {
            container.innerHTML = "<p>No files found</p>";
            return;
        }

        res.result.files.forEach(file => {
            const card = document.createElement("div");
            card.className = "card";

            const icon = document.createElement("div");
            const isFolder = file.mimeType === "application/vnd.google-apps.folder";
            const isSpreadsheet = file.mimeType === "application/vnd.google-apps.spreadsheet";
            
            if (isFolder) {
                icon.className = "folder-icon";
                icon.textContent = "ğŸ“";
            } else if (isSpreadsheet) {
                icon.className = "excel-icon";
                icon.textContent = "ğŸ“Š";
            } else {
                icon.className = "file-icon";
                icon.textContent = "ğŸ“„";
            }

            const name = document.createElement("div");
            name.className = "filename";
            name.textContent = file.name;

            card.appendChild(icon);
            card.appendChild(name);

            if (isFolder) {
                card.onclick = () => {
                    folderStack.push(file.id);
                    loadFolder(file.id);
                };
            } else if (isSpreadsheet) {
                // Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ù„ÙØªØ­ Ø§Ù„Ø¬Ø¯ÙˆÙ„
                const excelBtn = document.createElement("button");
                excelBtn.className = "excel-btn";
                excelBtn.textContent = "Open as Table";
                excelBtn.onclick = (e) => {
                    e.stopPropagation();
                    loadSpreadsheet(file.id, file.name);
                };
                card.appendChild(excelBtn);
                
                // Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ø±Ø¯ ÙŠÙØªØ­ ÙÙŠ Google Sheets
                card.onclick = () => {
                    window.open(
                        `https://docs.google.com/spreadsheets/d/${file.id}/edit`,
                        "_blank"
                    );
                };
            } else {
                card.onclick = () => {
                    window.open(
                        `https://drive.google.com/file/d/${file.id}/view`,
                        "_blank"
                    );
                };
            }

            container.appendChild(card);
        });

    } catch (err) {
        console.error(err);
        alert("Error loading files. Please sign in again.");
    }
}

// ØªØ­Ù…ÙŠÙ„ ÙˆØ¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Excel
async function loadSpreadsheet(spreadsheetId, spreadsheetName) {
    try {
        const container = document.getElementById("tableContainer");
        container.style.display = "block";
        container.innerHTML = `<div class="loading">Loading spreadsheet: ${spreadsheetName}...</div>`;
        
        document.getElementById("closeTableBtn").style.display = "inline-block";
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„ØµÙØ­Ø§Øª (Sheets)
        const spreadsheet = await gapi.client.sheets.spreadsheets.get({
            spreadsheetId: spreadsheetId
        });
        
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£ÙˆÙ„ ØµÙØ­Ø© (Sheet) ÙÙŠ Ø§Ù„Ù…Ù„Ù
        const sheetName = spreadsheet.result.sheets[0].properties.title;
        
        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ØµÙØ­Ø©
        const rangeResponse = await gapi.client.sheets.spreadsheets.values.get({
            spreadsheetId: spreadsheetId,
            range: sheetName
        });
        
        const values = rangeResponse.result.values;
        
        if (!values || values.length === 0) {
            container.innerHTML = `<h3>${spreadsheetName}</h3><p>No data found in the spreadsheet.</p>`;
            return;
        }
        
        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        let tableHTML = `<h3>ğŸ“Š ${spreadsheetName} - ${sheetName}</h3>`;
        tableHTML += `<table>`;
        
        // Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙƒØ¹Ù†Ø§ÙˆÙŠÙ† (headers)
        tableHTML += `<thead><tr>`;
        if (values[0]) {
            values[0].forEach(cell => {
                tableHTML += `<th>${cell || ''}</th>`;
            });
        }
        tableHTML += `</tr></thead>`;
        
        // Ø¨Ù‚ÙŠØ© Ø§Ù„ØµÙÙˆÙ ÙƒØ¨ÙŠØ§Ù†Ø§Øª
        tableHTML += `<tbody>`;
        for (let i = 1; i < values.length; i++) {
            tableHTML += `<tr>`;
            values[i].forEach(cell => {
                tableHTML += `<td>${cell || ''}</td>`;
            });
            // Ø¥Ø¶Ø§ÙØ© Ø®Ù„Ø§ÙŠØ§ ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØµÙ ØºÙŠØ± Ù…ÙƒØªÙ…Ù„
            if (values[i].length < values[0].length) {
                for (let j = values[i].length; j < values[0].length; j++) {
                    tableHTML += `<td></td>`;
                }
            }
            tableHTML += `</tr>`;
        }
        tableHTML += `</tbody></table>`;
        
        container.innerHTML = tableHTML;
        currentSpreadsheetId = spreadsheetId;
        
    } catch (err) {
        console.error("Error loading spreadsheet:", err);
        document.getElementById("tableContainer").innerHTML = 
            `<div class="loading">Error loading spreadsheet: ${err.message}</div>`;
    }
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ø¯ÙˆÙ„
function closeTable() {
    document.getElementById("tableContainer").style.display = "none";
    document.getElementById("closeTableBtn").style.display = "none";
    currentSpreadsheetId = null;
}

// Go back
function goBack() {
    if (folderStack.length > 1) {
        folderStack.pop();
        loadFolder(folderStack[folderStack.length - 1]);
    }
    closeTable();
}
</script>

</body>
</html>
